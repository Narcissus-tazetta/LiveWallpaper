name: release

on:
    workflow_dispatch:
        inputs:
            version:
                required: true
                type: string
            build_number:
                required: false
                default: "1"
                type: string

permissions:
    contents: write

jobs:
    build-and-publish:
        runs-on: macos-14
        steps:
            - uses: actions/checkout@v4

            - name: Build zip
              env:
                  SPARKLE_PUBLIC_ED_KEY: ${{ secrets.SPARKLE_PUBLIC_ED_KEY }}
                  SPARKLE_APPCAST_URL: https://raw.githubusercontent.com/Narcissus-tazetta/LiveWallpaper/main/docs/appcast.xml
                  ARCH_MODE: universal
              run: |
                  chmod +x scripts/package_zip.sh
                  ./scripts/package_zip.sh "${{ inputs.version }}" "${{ inputs.build_number }}"

            - name: Generate appcast
              env:
                  SPARKLE_PRIVATE_ED_KEY: ${{ secrets.SPARKLE_PRIVATE_ED_KEY }}
              run: |
                  if [[ -z "$SPARKLE_PRIVATE_ED_KEY" ]]; then
                      echo "Missing secret: SPARKLE_PRIVATE_ED_KEY" >&2
                      exit 1
                  fi

                  KEY_FILE="$RUNNER_TEMP/sparkle-private.pem"
                  if [[ "$SPARKLE_PRIVATE_ED_KEY" == *"BEGIN PRIVATE KEY"* ]]; then
                      printf '%s' "$SPARKLE_PRIVATE_ED_KEY" | sed $'s/\\\\n/\\\n/g' > "$KEY_FILE"
                  else
                      KEY_BODY="$(printf '%s' "$SPARKLE_PRIVATE_ED_KEY" | tr -d '[:space:]')"
                      {
                          echo "-----BEGIN PRIVATE KEY-----"
                          echo "$KEY_BODY" | fold -w 64
                          echo "-----END PRIVATE KEY-----"
                      } > "$KEY_FILE"
                  fi

                  chmod 600 "$KEY_FILE"

                  if ! openssl pkey -in "$KEY_FILE" -noout >/dev/null 2>&1; then
                      echo "Invalid SPARKLE_PRIVATE_ED_KEY format" >&2
                      exit 1
                  fi

                  python3 -m venv "$RUNNER_TEMP/pyenv"
                  source "$RUNNER_TEMP/pyenv/bin/activate"
                  python -m pip install -q --upgrade pip
                  python -m pip install -q cryptography
                  chmod +x scripts/sign_zip.py
                  chmod +x scripts/generate_appcast.sh
                  ZIP_PATH="dist/LiveWallpaper-macos-v${{ inputs.version }}.zip"
                  DOWNLOAD_URL="https://github.com/Narcissus-tazetta/LiveWallpaper/releases/download/v${{ inputs.version }}/LiveWallpaper-macos-v${{ inputs.version }}.zip"
                  SPARKLE_ED_SIGNATURE="$(python scripts/sign_zip.py "$KEY_FILE" "$ZIP_PATH")"
                  ./scripts/generate_appcast.sh "${{ inputs.version }}" "$ZIP_PATH" "$DOWNLOAD_URL" "$SPARKLE_ED_SIGNATURE" "docs/appcast.xml" "https://github.com/Narcissus-tazetta/LiveWallpaper/releases/tag/v${{ inputs.version }}"

            - name: Commit appcast
              run: |
                  git config user.name github-actions
                  git config user.email github-actions@github.com
                  git add docs/appcast.xml
                  git commit -m "chore: update appcast v${{ inputs.version }}" || true
                  git push

            - name: Create release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release create "v${{ inputs.version }}" "dist/LiveWallpaper-macos-v${{ inputs.version }}.zip" --title "v${{ inputs.version }}" --notes "LiveWallpaper v${{ inputs.version }}"
